[
  {
    "id": "cb25fa82.4b5a98",
    "type": "tab",
    "label": "Control",
    "disabled": false,
    "info": ""
  },
  {
    "id": "f0a27113.452c7",
    "type": "tab",
    "label": "WIFI Management",
    "disabled": true,
    "info": ""
  },
  {
    "id": "8ad7ff70.e6588",
    "type": "tab",
    "label": "VIdeo",
    "disabled": false,
    "info": ""
  },
  {
    "id": "4390874a.e06198",
    "type": "tab",
    "label": "Internet monitor",
    "disabled": true,
    "info": ""
  },
  {
    "id": "bfa9dbf7.1685d8",
    "type": "tab",
    "label": "Kirke",
    "disabled": true,
    "info": ""
  },
  {
    "id": "c0fec770.f6d2e8",
    "type": "ui_base",
    "theme": {
      "name": "theme-dark",
      "lightTheme": {
        "default": "#0094CE",
        "baseColor": "#0094CE",
        "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
        "edited": true,
        "reset": false
      },
      "darkTheme": {
        "default": "#097479",
        "baseColor": "#286467",
        "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
        "edited": true,
        "reset": false
      },
      "customTheme": {
        "name": "Untitled Theme 1",
        "default": "#4B7930",
        "baseColor": "#4B7930",
        "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
      },
      "themeState": {
        "base-color": {
          "default": "#097479",
          "value": "#286467",
          "edited": true
        },
        "page-titlebar-backgroundColor": {
          "value": "#286467",
          "edited": false
        },
        "page-backgroundColor": {
          "value": "#111111",
          "edited": false
        },
        "page-sidebar-backgroundColor": {
          "value": "#333333",
          "edited": false
        },
        "group-textColor": {
          "value": "#3d999e",
          "edited": false
        },
        "group-borderColor": {
          "value": "#555555",
          "edited": false
        },
        "group-backgroundColor": {
          "value": "#333333",
          "edited": false
        },
        "widget-textColor": {
          "value": "#eeeeee",
          "edited": false
        },
        "widget-backgroundColor": {
          "value": "#286467",
          "edited": false
        },
        "widget-borderColor": {
          "value": "#333333",
          "edited": false
        },
        "base-font": {
          "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
        }
      },
      "angularTheme": {
        "primary": "indigo",
        "accents": "blue",
        "warn": "red",
        "background": "grey"
      }
    },
    "site": {
      "name": "Node-RED Dashboard",
      "hideToolbar": "false",
      "allowSwipe": "false",
      "lockMenu": "false",
      "allowTempTheme": "true",
      "dateFormat": "DD/MM/YYYY",
      "sizes": {
        "sx": 62,
        "sy": 48,
        "gx": 6,
        "gy": 6,
        "cx": 6,
        "cy": 6,
        "px": 0,
        "py": 0
      }
    }
  },
  {
    "id": "aa342482.6c99b8",
    "type": "ui_group",
    "name": "Group 1",
    "tab": "",
    "order": 1,
    "disp": true,
    "width": 6
  },
  {
    "id": "f810c076.082ec",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "73f3087e.5c85b8",
    "order": 1,
    "width": 1,
    "height": 1
  },
  {
    "id": "be55a7a0.97c408",
    "type": "MySQLdatabase",
    "name": "infoscreen.klikdata.dk",
    "host": "database.klikdata.dk",
    "port": "33307",
    "db": "KlikViewer",
    "tz": "",
    "charset": "UTF8"
  },
  {
    "id": "a908c8f3.af46e8",
    "type": "ui_group",
    "name": "Ipad",
    "tab": "",
    "order": 1,
    "disp": false,
    "width": 20,
    "collapse": false
  },
  {
    "id": "7ffff59a.e4af8c",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 1,
    "width": 28,
    "height": 1
  },
  {
    "id": "b7f92a27.efc398",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 2,
    "width": 28,
    "height": 1
  },
  {
    "id": "1e60f3ad.ae2f7c",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 3,
    "width": 28,
    "height": 1
  },
  {
    "id": "1bef9565.d040ab",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 5,
    "width": 1,
    "height": 1
  },
  {
    "id": "77e7c4e5.595a0c",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 7,
    "width": 14,
    "height": 1
  },
  {
    "id": "b4e781b2.2ae4d",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 8,
    "width": 28,
    "height": 1
  },
  {
    "id": "c2652c03.07acc",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 9,
    "width": 28,
    "height": 1
  },
  {
    "id": "e650ed21.bea6d",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 10,
    "width": 28,
    "height": 1
  },
  {
    "id": "f88bbdb9.8451b",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 11,
    "width": 28,
    "height": 1
  },
  {
    "id": "e7444ff3.56dc2",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 12,
    "width": 28,
    "height": 1
  },
  {
    "id": "e7ec6ff0.5f385",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 13,
    "width": 28,
    "height": 1
  },
  {
    "id": "3480f469.1d270c",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 14,
    "width": 28,
    "height": 1
  },
  {
    "id": "dccee21f.67519",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 15,
    "width": 28,
    "height": 1
  },
  {
    "id": "5b5e3dc.f14d8c4",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 16,
    "width": 28,
    "height": 1
  },
  {
    "id": "95995e9a.2ece6",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 17,
    "width": 28,
    "height": 1
  },
  {
    "id": "ca7070b4.ee9b1",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 22,
    "width": 15,
    "height": 1
  },
  {
    "id": "df3fc301.ce461",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 23,
    "width": 15,
    "height": 1
  },
  {
    "id": "80864f2c.1365c",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 27,
    "width": 15,
    "height": 1
  },
  {
    "id": "ed89ab64.7287b8",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 28,
    "width": 15,
    "height": 1
  },
  {
    "id": "93f565fe.6178a8",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 31,
    "width": 15,
    "height": 1
  },
  {
    "id": "5c26c245.5840bc",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 32,
    "width": 15,
    "height": 1
  },
  {
    "id": "8acb1c68.18c9e",
    "type": "MySQLdatabase",
    "name": "KlikSampler",
    "host": "192.168.40.240",
    "port": "3307",
    "db": "Kliksampler",
    "tz": "",
    "charset": "UTF8"
  },
  {
    "id": "dad56cdc.278ca",
    "type": "mqtt-broker",
    "name": "",
    "broker": "localhost",
    "port": "4789",
    "clientid": "",
    "usetls": false,
    "compatmode": true,
    "keepalive": "60",
    "cleansession": true,
    "birthTopic": "",
    "birthQos": "0",
    "birthPayload": "",
    "closeTopic": "",
    "closeQos": "0",
    "closePayload": "",
    "willTopic": "",
    "willQos": "0",
    "willPayload": ""
  },
  {
    "id": "907bbe60.b555f",
    "type": "ui_tab",
    "name": "Klik viewer Wifi",
    "icon": "wifi",
    "disabled": false,
    "hidden": false
  },
  {
    "id": "ecc1e1bb.da106",
    "type": "ui_group",
    "name": "Url",
    "tab": "907bbe60.b555f",
    "order": 3,
    "disp": true,
    "width": "6",
    "collapse": false
  },
  {
    "id": "1a12e7fe.94bab8",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 1,
    "width": 28,
    "height": 1
  },
  {
    "id": "a7499ed.f745a6",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 2,
    "width": 28,
    "height": 1
  },
  {
    "id": "458c56ac.8eb4b8",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 3,
    "width": 28,
    "height": 1
  },
  {
    "id": "dcccb526.8bee58",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 4,
    "width": 28,
    "height": 1
  },
  {
    "id": "9efac20f.d5df6",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 5,
    "width": 28,
    "height": 1
  },
  {
    "id": "953dfbae.821d78",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 6,
    "width": 28,
    "height": 1
  },
  {
    "id": "23bf9a51.cd8cc6",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 7,
    "width": 28,
    "height": 1
  },
  {
    "id": "6cfcafb5.902d5",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 8,
    "width": 28,
    "height": 1
  },
  {
    "id": "d648a332.411a3",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 9,
    "width": 28,
    "height": 1
  },
  {
    "id": "608d9bb5.130714",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 10,
    "width": 28,
    "height": 1
  },
  {
    "id": "f5f39486.77fb58",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 11,
    "width": 28,
    "height": 1
  },
  {
    "id": "9eec2617.85db18",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 12,
    "width": 28,
    "height": 1
  },
  {
    "id": "de3d196a.66ff88",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 13,
    "width": 28,
    "height": 1
  },
  {
    "id": "f1684963.814438",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 14,
    "width": 15,
    "height": 1
  },
  {
    "id": "2b07fd62.bd2ae2",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 19,
    "width": 15,
    "height": 1
  },
  {
    "id": "7d1076ec.8d85f8",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 20,
    "width": 15,
    "height": 1
  },
  {
    "id": "7e0ada50.bceab4",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 24,
    "width": 15,
    "height": 1
  },
  {
    "id": "14e70c30.e65af4",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 25,
    "width": 15,
    "height": 1
  },
  {
    "id": "4b015a44.8e7134",
    "type": "ui_spacer",
    "name": "spacer",
    "group": "",
    "order": 28,
    "width": 15,
    "height": 1
  },
  {
    "id": "43777087.3cf8b",
    "type": "MySQLdatabase",
    "name": "sql.ufi-tech.dk",
    "host": "sql.ufi-tech.dk",
    "port": "42351",
    "db": "Ufi-Tech",
    "tz": "",
    "charset": "UTF8"
  },
  {
    "id": "4d0f060d.dee7e8",
    "type": "ui_group",
    "name": "Update",
    "tab": "907bbe60.b555f",
    "order": 2,
    "disp": false,
    "width": "6",
    "collapse": false
  },
  {
    "id": "a1e7431b.229d5",
    "type": "ui_group",
    "name": "Settings",
    "tab": "907bbe60.b555f",
    "order": 1,
    "disp": false,
    "width": "6",
    "collapse": false
  },
  {
    "id": "b39b5989.763da8",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "func": "var sqlmsg = {topic :\"select * from infoscreen WHERE MAC=\\'ufi_tech-\"+flow.get(\"mac\")+\"\\'\"} ;\nreturn sqlmsg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 440,
    "y": 40,
    "wires": [
      [
        "c3c2a4f7.804228"
      ]
    ]
  },
  {
    "id": "c709a738.af27d8",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "60",
    "crontab": "",
    "once": true,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 150,
    "y": 180,
    "wires": [
      [
        "739dfbae.adcd04",
        "b39b5989.763da8",
        "49b8d18e.34d86"
      ]
    ]
  },
  {
    "id": "739dfbae.adcd04",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "ip link",
    "addpay": "",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 470,
    "y": 220,
    "wires": [
      [
        "7fafd4b8.e6b52c"
      ],
      [],
      []
    ]
  },
  {
    "id": "7fafd4b8.e6b52c",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Gem Mac addresse",
    "func": "// Funktion til at udtrække MAC-adressen for det første ikke-loopback interface\nlet outputLines = msg.payload.split(\"↵\");\nlet macAddress = \"\";\n\nfor (let i = 0; i < outputLines.length; i++) {\n    if (outputLines[i].includes(\"link/ether\")) {\n        // Få MAC-adressen fra linjen\n        let match = outputLines[i].match(/link\\/ether ([\\w\\d:]+)/);\n        if (match && match.length > 1) {\n            macAddress = match[1];\n            break;\n        }\n    }\n}\n\n// Fjern koloner fra MAC-adressen\nmacAddress = macAddress.replace(/:/g, '');\n\n// Sæt MAC-adressen som den nye payload\nmsg.payload = macAddress;\n\n\nflow.set(\"mac\",msg.payload);\n\nreturn msg;\n\n\n\n\n//var res = msg.payload.replace(/ /g,'');\n//var msgsql = {topic: \"UPDATE infoscreen SET Online=1 WHERE MAC=\\'klikdata-\"+msg.payload+\"\\'\"}; \n//msgsql.payload = msg.payload.trim()res +\"5455\"    ;\n\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 470,
    "y": 280,
    "wires": [
      [
        "24b6dbdd.881184"
      ]
    ]
  },
  {
    "id": "7a21cc63.d17524",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "hostname -I",
    "addpay": "",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "hostname -I",
    "x": 450,
    "y": 460,
    "wires": [
      [
        "56c18f75.e098b"
      ],
      [],
      []
    ]
  },
  {
    "id": "56c18f75.e098b",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "opdater database med online ",
    "func": "msg.payload = msg.payload.trim();\nflow.set('localip',msg.payload);\n\n//var res = msg.payload.replace(/ /g,'');\n//var msgsql = {topic: \"UPDATE infoscreen SET Online=1, IP=\\'\"+msg.payload+\"\\', wan=\\'\"+flow.get(\"wan\")+\"\\' WHERE MAC=\\'klikdata-\"+flow.get(\"mac\")+\"\\'\"}; \n//msgsql.payload = msg.payload.trim()res +\"5455\"    ;\n\n//return [msgsql];\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 500,
    "y": 520,
    "wires": [
      []
    ]
  },
  {
    "id": "24b6dbdd.881184",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "curl curl https://icanhazip.com/",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "Call IP - whatismyipaddress.com",
    "x": 510,
    "y": 340,
    "wires": [
      [
        "785d76eb.b49938"
      ],
      [],
      []
    ]
  },
  {
    "id": "785d76eb.b49938",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Wan ip",
    "func": "msg.payload = msg.payload.trim();\nflow.set(\"wan\",msg.payload);\nreturn msg;\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 430,
    "y": 400,
    "wires": [
      [
        "7a21cc63.d17524"
      ]
    ]
  },
  {
    "id": "5952f71c.54db78",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Set support = 0",
    "func": "if (!msg.payload || !msg.payload[0]) {\n    return null;\n}\n\nif (msg.payload[0].Support!=\"0\" ){\n    var msgsql = {topic: \"UPDATE infoscreen SET Support=0 WHERE MAC=\\'ufi_tech-\"+flow.get(\"mac\")+\"\\'\"}; \n    node.send(msgsql);\n}\n\n\n\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1220,
    "y": 280,
    "wires": [
      [
        "4fa26531.796f0c"
      ]
    ]
  },
  {
    "id": "e927287d.2f19f8",
    "type": "mysql",
    "z": "cb25fa82.4b5a98",
    "mydb": "43777087.3cf8b",
    "name": "sql.ufi-tech.dk",
    "x": 780,
    "y": 40,
    "wires": [
      [
        "5952f71c.54db78",
        "b7c1ba44.9ba2c8",
        "be9309c6.c48c58",
        "47202b51.20fad4",
        "dda70fed.310c2",
        "cda4fa02.432388",
        "29b0a2ff.88f57e",
        "23be0d4c.212562",
        "9483ecb0.ab179",
        "809771b7.2a3b"
      ]
    ]
  },
  {
    "id": "c3c2a4f7.804228",
    "type": "delay",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "pauseType": "delay",
    "timeout": "2",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "outputs": 1,
    "x": 600,
    "y": 40,
    "wires": [
      [
        "e927287d.2f19f8"
      ]
    ]
  },
  {
    "id": "5234c393.a066dc",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 1610,
    "y": 60,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "b7c1ba44.9ba2c8",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Support",
    "func": "if (!msg.payload || !msg.payload[0]) {\n    return null;\n}\n\nif (msg.payload[0].Support==\"1\"){\n     msg.payload=\"sudo vncserver-x11 -service -connect sql.ufi-tech.dk::36666\"\n    node.send(msg);\n}\n\n\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1240,
    "y": 60,
    "wires": [
      [
        "5234c393.a066dc"
      ]
    ]
  },
  {
    "id": "4fa26531.796f0c",
    "type": "mysql",
    "z": "cb25fa82.4b5a98",
    "mydb": "43777087.3cf8b",
    "name": "sql.ufi-tech.dk",
    "x": 1460,
    "y": 260,
    "wires": [
      []
    ]
  },
  {
    "id": "be9309c6.c48c58",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Reboot",
    "func": "if (!msg.payload || !msg.payload[0]) {\n    return null;\n}\n\nif (msg.payload[0].Support==\"2\"){\n     msg.payload=\"sudo reboot /f\"\n    node.send(msg);\n}\n\n\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1240,
    "y": 120,
    "wires": [
      [
        "5234c393.a066dc"
      ]
    ]
  },
  {
    "id": "47202b51.20fad4",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Set online = 0",
    "func": "    var msgsql = {topic: \"UPDATE infoscreen SET Online=\\'0\\' WHERE MAC=\\'ufi_tech-\"+flow.get(\"mac\")+\"\\'\"}; \n    node.send(msgsql);\n\n\n\n\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1220,
    "y": 240,
    "wires": [
      [
        "4fa26531.796f0c"
      ]
    ]
  },
  {
    "id": "dda70fed.310c2",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Url Control",
    "func": "if (!msg.payload || !msg.payload[0]) {\n    return null;\n}\n\nmsg.test = global.get('urlstore');\nif (global.get('urlstore') != msg.payload[0].Url) {\n    global.set('urlstore', msg.payload[0].Url);\n    \n    // Detect Pi model for optimal GPU flags\n    var fs = global.get('fs') || require('fs');\n    var model = \"\";\n    try {\n        model = fs.readFileSync('/proc/device-tree/model', 'utf8');\n    } catch(e) {\n        model = \"unknown\";\n    }\n    \n    // Base flags for all models\n    var baseFlags = [\n        \"pkill chromium; sleep 1;\",\n        \"DISPLAY=:0 chromium\",\n        \"--kiosk\",\n        \"--autoplay-policy=no-user-gesture-required\",\n        \"--disable-restore-session-state\",\n        \"--disable-session-crashed-bubble\",\n        \"--noerrordialogs\",\n        \"--disable-infobars\",\n        \"--disable-features=Translate\",\n        \"--disable-translate\",\n        \"--no-first-run\",\n        \"--start-fullscreen\",\n        \"--window-position=0,0\",\n        \"--window-size=1920,1080\",\n        \"--no-sandbox\",\n        \"--disable-dev-shm-usage\",\n        \"--user-stylesheet=file:///home/pi/hide-translate.css\"\n    ];\n    \n    // GPU flags based on Pi model\n    if (model.indexOf(\"Pi 4\") !== -1 || model.indexOf(\"Pi 5\") !== -1) {\n        // Pi 4/5: Full GPU acceleration\n        baseFlags.push(\"--ignore-gpu-blocklist\");\n        baseFlags.push(\"--enable-gpu-rasterization\");\n        baseFlags.push(\"--enable-zero-copy\");\n        baseFlags.push(\"--enable-features=VaapiVideoDecoder\");\n        baseFlags.push(\"--use-gl=egl\");\n    } else if (model.indexOf(\"Pi 3\") !== -1) {\n        // Pi 3: Limited GPU, use software rendering for stability\n        baseFlags.push(\"--disable-gpu\");\n        baseFlags.push(\"--disable-software-rasterizer\");\n    } else {\n        // Pi Zero/2/Unknown: Minimal flags\n        baseFlags.push(\"--disable-gpu\");\n    }\n    \n    msg.payload = baseFlags.join(\" \") + \" '\" + global.get('urlstore') + \"'\";\n    node.send(msg);\n}",
    "outputs": 1,
    "noerr": 0,
    "initialize": "// Code added here will be run once\n// whenever the node is started.\nflow.set('box45sumplan',\"false\");",
    "finalize": "",
    "libs": [],
    "x": 1210,
    "y": 200,
    "wires": [
      [
        "8721c59a.0ebba8"
      ]
    ]
  },
  {
    "id": "8721c59a.0ebba8",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 1610,
    "y": 180,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "f7d65dbd.8aba5",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "hent url offline",
    "func": "// Start Chromium on Node-RED startup - Multi-model compatible\nif (global.get('urlstore') != \"\") {\n    var fs = global.get('fs') || require('fs');\n    var model = \"\";\n    try {\n        model = fs.readFileSync('/proc/device-tree/model', 'utf8');\n    } catch(e) {\n        model = \"unknown\";\n    }\n    \n    var baseFlags = [\n        \"pkill chromium; sleep 1;\",\n        \"DISPLAY=:0 chromium\",\n        \"--kiosk\",\n        \"--autoplay-policy=no-user-gesture-required\",\n        \"--disable-restore-session-state\",\n        \"--disable-session-crashed-bubble\",\n        \"--noerrordialogs\",\n        \"--disable-infobars\",\n        \"--disable-features=Translate\",\n        \"--disable-translate\",\n        \"--no-first-run\",\n        \"--start-fullscreen\",\n        \"--window-position=0,0\",\n        \"--window-size=1920,1080\",\n        \"--no-sandbox\",\n        \"--disable-dev-shm-usage\",\n        \"--user-stylesheet=file:///home/pi/hide-translate.css\"\n    ];\n    \n    if (model.indexOf(\"Pi 4\") !== -1 || model.indexOf(\"Pi 5\") !== -1) {\n        baseFlags.push(\"--ignore-gpu-blocklist\");\n        baseFlags.push(\"--enable-gpu-rasterization\");\n        baseFlags.push(\"--enable-zero-copy\");\n        baseFlags.push(\"--enable-features=VaapiVideoDecoder\");\n        baseFlags.push(\"--use-gl=egl\");\n    } else if (model.indexOf(\"Pi 3\") !== -1) {\n        baseFlags.push(\"--disable-gpu\");\n        baseFlags.push(\"--disable-software-rasterizer\");\n    } else {\n        baseFlags.push(\"--disable-gpu\");\n    }\n    \n    msg.payload = baseFlags.join(\" \") + \" '\" + global.get('urlstore') + \"'\";\n    node.send(msg);\n}",
    "outputs": 1,
    "noerr": 0,
    "initialize": "// Code added here will be run once\n",
    "finalize": "",
    "libs": [],
    "x": 1760,
    "y": 360,
    "wires": [
      [
        "ba41aee8.91382"
      ]
    ]
  },
  {
    "id": "2dd811fc.d895fe",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "Injeckt on start",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": true,
    "onceDelay": "1",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 1520,
    "y": 360,
    "wires": [
      [
        "f7d65dbd.8aba5"
      ]
    ]
  },
  {
    "id": "b2d5eaa0.09a668",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Bakup af pi",
    "func": "\n\n    msg.payload=(\"sudo sh /home/pi/baxkup.sh\");\n    node.send(msg);\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "// Code added here will be run once\n",
    "finalize": "",
    "libs": [],
    "x": 1770,
    "y": 420,
    "wires": [
      [
        "1a722817.468988"
      ]
    ]
  },
  {
    "id": "29a3685b.208558",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 1500,
    "y": 420,
    "wires": [
      [
        "b2d5eaa0.09a668"
      ]
    ]
  },
  {
    "id": "49b8d18e.34d86",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "func": "var sqlmsg = {topic : \"SELECT * FROM infoscreen WHERE MAC=\\'ufi_tech-\"+flow.get(\"mac\")+\"\\' LIMIT 1\"};\nreturn sqlmsg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 340,
    "y": 640,
    "wires": [
      [
        "89c5235f.e6ac6"
      ]
    ]
  },
  {
    "id": "24a9ac16.0fcca4",
    "type": "switch",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "property": "kontrol",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "0",
        "vt": "num"
      },
      {
        "t": "else"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 2,
    "x": 1010,
    "y": 640,
    "wires": [
      [
        "b23d7d04.9e865"
      ],
      [
        "3e00e4cc.de8d2c"
      ]
    ]
  },
  {
    "id": "b23d7d04.9e865",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "INSERT INTO Device",
    "func": "var sqlmsg = {topic : \"INSERT INTO infoscreen (MAC) VALUES  (\\'ufi_tech-\"+flow.get(\"mac\")+\"\\')\"};\nreturn sqlmsg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1200,
    "y": 600,
    "wires": [
      [
        "6a7a59b5.a1be98"
      ]
    ]
  },
  {
    "id": "3e00e4cc.de8d2c",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Update Device",
    "func": "//msg.payload = msg.payload.trim();\n\n\n//var res = msg.payload.replace(/ /g,'');\nvar msgsql = {topic: \"UPDATE infoscreen SET Online=1, IP=\\'\"+flow.get('localip',)+\"\\', wan=\\'\"+flow.get(\"wan\")+\"\\' WHERE MAC=\\'ufi_tech-\"+flow.get(\"mac\")+\"\\'\"}; \n//msgsql.payload = msg.payload.trim()res +\"5455\"    ;\n\nreturn [msgsql];\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1180,
    "y": 660,
    "wires": [
      [
        "6a7a59b5.a1be98"
      ]
    ]
  },
  {
    "id": "25d187e4.a025f8",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Kontroler Om Enheden findes i database",
    "func": "kontrol =\"\";\nvar length = msg.payload.length;\nmsg.kontrol = length;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "x": 760,
    "y": 640,
    "wires": [
      [
        "24a9ac16.0fcca4"
      ]
    ]
  },
  {
    "id": "89c5235f.e6ac6",
    "type": "mysql",
    "z": "cb25fa82.4b5a98",
    "mydb": "43777087.3cf8b",
    "name": "sql.ufi-tech.dk",
    "x": 500,
    "y": 640,
    "wires": [
      [
        "25d187e4.a025f8"
      ]
    ]
  },
  {
    "id": "6a7a59b5.a1be98",
    "type": "mysql",
    "z": "cb25fa82.4b5a98",
    "mydb": "43777087.3cf8b",
    "name": "sql.ufi-tech.dk",
    "x": 1500,
    "y": 640,
    "wires": [
      []
    ]
  },
  {
    "id": "cda4fa02.432388",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "tvon",
    "func": "if (!msg.payload || !msg.payload[0]) {\n    return null;\n}\n\nif ((msg.payload[0].TVON==\"1\")&& (flow.get(\"tvon\") != msg.payload[0].TVON)){\n    flow.set(\"tvon\",msg.payload[0].TVON)\n     msg.payload=\"sudo echo 'on 0.0.0.0' | cec-client -s -d 1\"\n     node.send(msg);\n}\nelse if ((msg.payload[0].TVON==\"0\")&& (flow.get(\"tvon\") != msg.payload[0].TVON)){\n     flow.set(\"tvon\",msg.payload[0].TVON)\n     msg.payload=\"sudo echo 'standby 0.0.0.0' | cec-client -s -d 1\"\n     node.send(msg);\n}\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 830,
    "y": 300,
    "wires": [
      [
        "f5c79593.38bfd8"
      ]
    ]
  },
  {
    "id": "ba41aee8.91382",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 2030,
    "y": 360,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "1a722817.468988",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 2030,
    "y": 420,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "f5c79593.38bfd8",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 950,
    "y": 300,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "3f6022a.f2b39de",
    "type": "ui_text_input",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "label": "URl",
    "tooltip": "",
    "group": "ecc1e1bb.da106",
    "order": 4,
    "width": 0,
    "height": 0,
    "passthru": true,
    "mode": "text",
    "delay": 300,
    "topic": "topic",
    "topicType": "msg",
    "x": 1210,
    "y": 520,
    "wires": [
      [
        "446f57ae.a2b3b8"
      ]
    ]
  },
  {
    "id": "29b0a2ff.88f57e",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "hent url offline",
    "func": "\nmsg.payload=global.get('urlstore');\nnode.send(msg);\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "// Code added here will be run once\n",
    "finalize": "",
    "libs": [],
    "x": 1220,
    "y": 360,
    "wires": [
      [
        "3f6022a.f2b39de"
      ]
    ]
  },
  {
    "id": "446f57ae.a2b3b8",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Update Device",
    "func": "//msg.payload = msg.payload.trim();\n\n\n//var res = msg.payload.replace(/ /g,'');\nvar msgsql = {topic: \"UPDATE infoscreen SET Url=\\'\"+msg.payload+\"\\' WHERE MAC=\\'ufi_tech-\"+flow.get(\"mac\")+\"\\'\"}; \n//msgsql.payload = msg.payload.trim()res +\"5455\"    ;\n\nreturn [msgsql];\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1420,
    "y": 520,
    "wires": [
      [
        "6a7a59b5.a1be98"
      ]
    ]
  },
  {
    "id": "48887b37.e89154",
    "type": "ui_form",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "label": "",
    "group": "ecc1e1bb.da106",
    "order": 2,
    "width": 0,
    "height": 0,
    "options": [
      {
        "label": "Url",
        "value": "url",
        "type": "text",
        "required": true,
        "rows": null
      },
      {
        "label": "Tænd Tv",
        "value": "TvTrue",
        "type": "time",
        "required": false,
        "rows": null
      },
      {
        "label": "Sluk Tv",
        "value": "TvFalse",
        "type": "time",
        "required": false,
        "rows": null
      },
      {
        "label": "Email",
        "value": "email",
        "type": "email",
        "required": true,
        "rows": null
      },
      {
        "label": "MobilNr",
        "value": "Mobil",
        "type": "number",
        "required": true,
        "rows": null
      }
    ],
    "formValue": {
      "url": "",
      "TvTrue": "",
      "TvFalse": "",
      "email": "",
      "Mobil": ""
    },
    "payload": "",
    "submit": "submit",
    "cancel": "cancel",
    "topic": "topic",
    "topicType": "msg",
    "splitLayout": "",
    "x": 2190,
    "y": 640,
    "wires": [
      []
    ]
  },
  {
    "id": "a68b4057.cac17",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Update Device",
    "func": "\nmsg.payload = {url: global.get('urlstore'), email: \"test2\"}\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 2020,
    "y": 640,
    "wires": [
      [
        "48887b37.e89154"
      ]
    ]
  },
  {
    "id": "1baffd1a.63ad33",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 1840,
    "y": 640,
    "wires": [
      [
        "a68b4057.cac17"
      ]
    ]
  },
  {
    "id": "23be0d4c.212562",
    "type": "json",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "property": "payload[0].camera",
    "action": "",
    "pretty": false,
    "x": 1230,
    "y": 20,
    "wires": [
      []
    ],
    "d": true
  },
  {
    "id": "9483ecb0.ab179",
    "type": "debug",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "true",
    "targetType": "full",
    "statusVal": "",
    "statusType": "auto",
    "x": 690,
    "y": 140,
    "wires": []
  },
  {
    "id": "809771b7.2a3b",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Kamera husk",
    "func": "if (!msg.payload || !msg.payload[0]) {\n    return null;\n}\n\nglobal.set('kirke', msg.payload[0].camera);\nglobal.set('kirke_true', msg.payload[0].Kirke);\n\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "// Code added here will be run once\n// whenever the node is started.\nflow.set('box45sumplan',\"false\");",
    "finalize": "",
    "libs": [],
    "x": 1210,
    "y": 320,
    "wires": [
      []
    ]
  },
  {
    "id": "e7b432ac.607bd",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "sudo vncserver-x11 -service -connect sql.ufi-tech.dk::36666",
    "payloadType": "str",
    "x": 1430,
    "y": 20,
    "wires": [
      [
        "5234c393.a066dc"
      ]
    ]
  },
  {
    "id": "failsafe_inject_ping",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "Internet Check (30s)",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "30",
    "crontab": "",
    "once": true,
    "onceDelay": "5",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 180,
    "y": 780,
    "wires": [
      [
        "failsafe_exec_ping"
      ]
    ]
  },
  {
    "id": "failsafe_exec_ping",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "ping -c 1 -W 2 8.8.8.8",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "5000",
    "oldrc": false,
    "name": "Ping 8.8.8.8",
    "x": 410,
    "y": 780,
    "wires": [
      [
        "failsafe_check_online"
      ],
      [
        "failsafe_check_offline"
      ],
      []
    ]
  },
  {
    "id": "failsafe_check_online",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Online - Genindlæs URL",
    "func": "// Internet er online\nvar wasOffline = flow.get('internetOffline') || false;\nflow.set('internetOffline', false);\n\n// Hvis vi var offline før, genindlæs den rigtige URL\nif (wasOffline && global.get('urlstore')) {\n    node.warn('Internet tilbage - genindlæser URL');\n    \n    var fs = global.get('fs') || require('fs');\n    var model = \"\";\n    try {\n        model = fs.readFileSync('/proc/device-tree/model', 'utf8');\n    } catch(e) {\n        model = \"unknown\";\n    }\n    \n    var baseFlags = [\n        \"pkill chromium; sleep 1;\",\n        \"DISPLAY=:0 chromium\",\n        \"--kiosk\",\n        \"--autoplay-policy=no-user-gesture-required\",\n        \"--disable-restore-session-state\",\n        \"--disable-session-crashed-bubble\",\n        \"--noerrordialogs\",\n        \"--disable-infobars\",\n        \"--disable-features=Translate\",\n        \"--disable-translate\",\n        \"--no-first-run\",\n        \"--start-fullscreen\",\n        \"--window-position=0,0\",\n        \"--window-size=1920,1080\",\n        \"--no-sandbox\",\n        \"--disable-dev-shm-usage\",\n        \"--user-stylesheet=file:///home/pi/hide-translate.css\"\n    ];\n    \n    if (model.indexOf(\"Pi 4\") !== -1 || model.indexOf(\"Pi 5\") !== -1) {\n        baseFlags.push(\"--ignore-gpu-blocklist\");\n        baseFlags.push(\"--enable-gpu-rasterization\");\n        baseFlags.push(\"--enable-zero-copy\");\n        baseFlags.push(\"--enable-features=VaapiVideoDecoder\");\n        baseFlags.push(\"--use-gl=egl\");\n    } else if (model.indexOf(\"Pi 3\") !== -1) {\n        baseFlags.push(\"--disable-gpu\");\n        baseFlags.push(\"--disable-software-rasterizer\");\n    } else {\n        baseFlags.push(\"--disable-gpu\");\n    }\n    \n    msg.payload = baseFlags.join(\" \") + \" '\" + global.get('urlstore') + \"'\";\n    return msg;\n}\n\nreturn null;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 690,
    "y": 760,
    "wires": [
      [
        "failsafe_exec_chromium",
        "25166551d568fc7c"
      ]
    ]
  },
  {
    "id": "failsafe_check_offline",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Offline - Vis fallback",
    "func": "// Internet er offline\nvar wasOnline = !flow.get('internetOffline');\nflow.set('internetOffline', true);\n\n// Hvis vi var online før, vis offline-side\nif (wasOnline) {\n    node.warn('Internet tabt - viser offline-side');\n    \n    var fs = global.get('fs') || require('fs');\n    var model = \"\";\n    try {\n        model = fs.readFileSync('/proc/device-tree/model', 'utf8');\n    } catch(e) {\n        model = \"unknown\";\n    }\n    \n    var baseFlags = [\n        \"pkill chromium; sleep 1;\",\n        \"DISPLAY=:0 chromium\",\n        \"--kiosk\",\n        \"--autoplay-policy=no-user-gesture-required\",\n        \"--disable-restore-session-state\",\n        \"--disable-session-crashed-bubble\",\n        \"--noerrordialogs\",\n        \"--disable-infobars\",\n        \"--disable-features=Translate\",\n        \"--disable-translate\",\n        \"--no-first-run\",\n        \"--start-fullscreen\",\n        \"--window-position=0,0\",\n        \"--window-size=1920,1080\",\n        \"--no-sandbox\",\n        \"--disable-dev-shm-usage\"\n    ];\n    \n    if (model.indexOf(\"Pi 4\") !== -1 || model.indexOf(\"Pi 5\") !== -1) {\n        baseFlags.push(\"--ignore-gpu-blocklist\");\n        baseFlags.push(\"--enable-gpu-rasterization\");\n        baseFlags.push(\"--enable-zero-copy\");\n        baseFlags.push(\"--use-gl=egl\");\n    } else if (model.indexOf(\"Pi 3\") !== -1) {\n        baseFlags.push(\"--disable-gpu\");\n        baseFlags.push(\"--disable-software-rasterizer\");\n    } else {\n        baseFlags.push(\"--disable-gpu\");\n    }\n    \n    msg.payload = baseFlags.join(\" \") + \" 'file:///home/pi/offline.html'\";\n    return msg;\n}\n\nreturn null;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 680,
    "y": 800,
    "wires": [
      [
        "failsafe_exec_chromium",
        "25166551d568fc7c"
      ]
    ]
  },
  {
    "id": "failsafe_exec_chromium",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "Start Chromium",
    "x": 960,
    "y": 780,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "failsafe_inject_watchdog",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "Chromium Watchdog (60s)",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "60",
    "crontab": "",
    "once": true,
    "onceDelay": "10",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 200,
    "y": 880,
    "wires": [
      [
        "failsafe_exec_pgrep"
      ]
    ]
  },
  {
    "id": "failsafe_exec_pgrep",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "pgrep chromium",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "pgrep chromium",
    "x": 440,
    "y": 880,
    "wires": [
      [
        "25166551d568fc7c"
      ],
      [
        "failsafe_chromium_crashed",
        "25166551d568fc7c"
      ],
      [
        "25166551d568fc7c"
      ]
    ]
  },
  {
    "id": "failsafe_chromium_crashed",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Chromium crashed - genstart",
    "func": "// Chromium kører ikke - genstart den\nnode.warn('Chromium ikke fundet - genstarter');\n\nvar isOffline = flow.get('internetOffline') || false;\nvar url = isOffline ? 'file:///home/pi/offline.html' : (global.get('urlstore') || 'file:///home/pi/setup.html');\n\nvar fs = global.get('fs') || require('fs');\nvar model = \"\";\ntry {\n    model = fs.readFileSync('/proc/device-tree/model', 'utf8');\n} catch(e) {\n    model = \"unknown\";\n}\n\nvar baseFlags = [\n    \"DISPLAY=:0 chromium\",\n    \"--kiosk\",\n    \"--autoplay-policy=no-user-gesture-required\",\n    \"--disable-restore-session-state\",\n    \"--disable-session-crashed-bubble\",\n    \"--noerrordialogs\",\n    \"--disable-infobars\",\n    \"--disable-features=Translate\",\n    \"--disable-translate\",\n    \"--no-first-run\",\n    \"--start-fullscreen\",\n    \"--window-position=0,0\",\n    \"--window-size=1920,1080\",\n    \"--no-sandbox\",\n    \"--disable-dev-shm-usage\",\n    \"--user-stylesheet=file:///home/pi/hide-translate.css\"\n];\n\nif (model.indexOf(\"Pi 4\") !== -1 || model.indexOf(\"Pi 5\") !== -1) {\n    baseFlags.push(\"--ignore-gpu-blocklist\");\n    baseFlags.push(\"--enable-gpu-rasterization\");\n    baseFlags.push(\"--enable-zero-copy\");\n    baseFlags.push(\"--enable-features=VaapiVideoDecoder\");\n    baseFlags.push(\"--use-gl=egl\");\n} else if (model.indexOf(\"Pi 3\") !== -1) {\n    baseFlags.push(\"--disable-gpu\");\n    baseFlags.push(\"--disable-software-rasterizer\");\n} else {\n    baseFlags.push(\"--disable-gpu\");\n}\n\nmsg.payload = baseFlags.join(\" \") + \" '\" + url + \"'\";\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 720,
    "y": 880,
    "wires": [
      [
        "failsafe_exec_chromium",
        "25166551d568fc7c"
      ]
    ]
  },
  {
    "id": "failsafe_comment",
    "type": "comment",
    "z": "cb25fa82.4b5a98",
    "name": "=== FAILSAFE: Internet Monitor + Chromium Watchdog ===",
    "info": "Internet Monitor:\n- Pinger 8.8.8.8 hver 30 sekunder\n- Hvis offline: Viser offline.html\n- Hvis online igen: Genindlæser URL fra urlstore\n\nChromium Watchdog:\n- Tjekker om Chromium kører hver 60 sekunder\n- Hvis crashed: Genstarter med korrekt URL",
    "x": 280,
    "y": 720,
    "wires": []
  },
  {
    "id": "25166551d568fc7c",
    "type": "debug",
    "z": "cb25fa82.4b5a98",
    "name": "debug 1",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "true",
    "targetType": "full",
    "statusVal": "",
    "statusType": "auto",
    "x": 900,
    "y": 940,
    "wires": []
  },
  {
    "id": "ec32ffa8.3f6f6",
    "type": "exec",
    "z": "f0a27113.452c7",
    "command": "sudo iwlist wlan0 scan | grep ESSID | sed 's/ESSID://g;s/\"//g;s/^ *//;s/ *$//'",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "scan",
    "x": 430,
    "y": 80,
    "wires": [
      [
        "e0d66c7a.647c9"
      ],
      [],
      []
    ]
  },
  {
    "id": "e0d66c7a.647c9",
    "type": "function",
    "z": "f0a27113.452c7",
    "name": "parseOptions",
    "func": "var ssids = msg.payload.split('\\n').filter(s => !!s)\n\nssids = [...new Set(ssids)];\n\nmsg.options = ssids\nmsg.payload = null\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 630,
    "y": 80,
    "wires": [
      [
        "617d9746.cbcbd8"
      ]
    ]
  },
  {
    "id": "a44c56bf.408c08",
    "type": "inject",
    "z": "f0a27113.452c7",
    "name": "",
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 260,
    "y": 221,
    "wires": [
      [
        "ec32ffa8.3f6f6",
        "80ce12b.e5edff",
        "9aa43ac5.df3728"
      ]
    ]
  },
  {
    "id": "617d9746.cbcbd8",
    "type": "ui_dropdown",
    "z": "f0a27113.452c7",
    "name": "",
    "label": "Wifi",
    "tooltip": "",
    "place": "Select a WIFI",
    "group": "4d0f060d.dee7e8",
    "order": 2,
    "width": 0,
    "height": 0,
    "passthru": false,
    "multiple": false,
    "options": [],
    "payload": "",
    "topic": "",
    "x": 830,
    "y": 67,
    "wires": [
      [
        "fc8462e2.6bc6e"
      ]
    ]
  },
  {
    "id": "f50dd378.27c7f",
    "type": "ui_button",
    "z": "f0a27113.452c7",
    "name": "",
    "group": "4d0f060d.dee7e8",
    "order": 1,
    "width": 0,
    "height": 0,
    "passthru": false,
    "label": "Scan",
    "tooltip": "",
    "color": "",
    "bgcolor": "",
    "icon": "",
    "payload": "true",
    "payloadType": "bool",
    "topic": "",
    "x": 250,
    "y": 140,
    "wires": [
      [
        "ec32ffa8.3f6f6"
      ]
    ]
  },
  {
    "id": "49307dfc.36fce4",
    "type": "ui_ui_control",
    "z": "f0a27113.452c7",
    "name": "onTab",
    "events": "all",
    "x": 130,
    "y": 80,
    "wires": [
      [
        "ee0231ae.607de"
      ]
    ]
  },
  {
    "id": "ee0231ae.607de",
    "type": "switch",
    "z": "f0a27113.452c7",
    "name": "ifWifi",
    "property": "name",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "Wifi",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 1,
    "x": 271,
    "y": 80,
    "wires": [
      [
        "ec32ffa8.3f6f6",
        "80ce12b.e5edff",
        "9aa43ac5.df3728"
      ]
    ]
  },
  {
    "id": "80ce12b.e5edff",
    "type": "exec",
    "z": "f0a27113.452c7",
    "command": "ifconfig wlan0",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "getInfo",
    "x": 430,
    "y": 181,
    "wires": [
      [
        "8a86d9a3.7ccca8"
      ],
      [],
      []
    ]
  },
  {
    "id": "8a86d9a3.7ccca8",
    "type": "function",
    "z": "f0a27113.452c7",
    "name": "parseInfo",
    "func": "var ip = msg.payload.match(/inet ([0-9\\.]+)/)[1]\nvar mask = msg.payload.match(/netmask ([0-9\\.]+)/)[1]\nvar broadcast = msg.payload.match(/broadcast ([0-9\\.]+)/)[1]\n\n\nnode.send({topic: 'ip', payload: ip})\nnode.send({topic: 'mask', payload: mask})\nnode.send({topic: 'broadcast', payload: broadcast})",
    "outputs": 1,
    "noerr": 0,
    "x": 640,
    "y": 168,
    "wires": [
      [
        "446ce308.eaab1c"
      ]
    ]
  },
  {
    "id": "446ce308.eaab1c",
    "type": "switch",
    "z": "f0a27113.452c7",
    "name": "",
    "property": "topic",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "ip",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "mask",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "broadcast",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 3,
    "x": 810,
    "y": 181,
    "wires": [
      [
        "d1ea316d.10c3d"
      ],
      [
        "8cadebd5.bedfe8"
      ],
      [
        "3592ebde.5596b4"
      ]
    ]
  },
  {
    "id": "d1ea316d.10c3d",
    "type": "ui_text",
    "z": "f0a27113.452c7",
    "group": "a1e7431b.229d5",
    "order": 3,
    "width": 0,
    "height": 0,
    "name": "",
    "label": "IP",
    "format": "{{msg.payload || '---'}}",
    "layout": "row-spread",
    "x": 990,
    "y": 141,
    "wires": []
  },
  {
    "id": "8cadebd5.bedfe8",
    "type": "ui_text",
    "z": "f0a27113.452c7",
    "group": "a1e7431b.229d5",
    "order": 4,
    "width": 0,
    "height": 0,
    "name": "",
    "label": "Netmask",
    "format": "{{msg.payload || '---'}}",
    "layout": "row-spread",
    "x": 1000,
    "y": 181,
    "wires": []
  },
  {
    "id": "3592ebde.5596b4",
    "type": "ui_text",
    "z": "f0a27113.452c7",
    "group": "a1e7431b.229d5",
    "order": 5,
    "width": 0,
    "height": 0,
    "name": "",
    "label": "Broadcast",
    "format": "{{msg.payload || '---'}}",
    "layout": "row-spread",
    "x": 1000,
    "y": 221,
    "wires": []
  },
  {
    "id": "4e417c79.0e9454",
    "type": "ui_form",
    "z": "f0a27113.452c7",
    "name": "",
    "label": "Update",
    "group": "4d0f060d.dee7e8",
    "order": 3,
    "width": 0,
    "height": 0,
    "options": [
      {
        "label": "SSID",
        "value": "ssid",
        "type": "text",
        "required": true,
        "rows": null
      },
      {
        "label": "Password",
        "value": "password",
        "type": "password",
        "required": true,
        "rows": null
      }
    ],
    "formValue": {
      "ssid": "",
      "password": ""
    },
    "payload": "",
    "submit": "UPDATE",
    "cancel": "RESET",
    "topic": "",
    "x": 1120,
    "y": 67,
    "wires": [
      [
        "562a8ec7.a7e76"
      ]
    ]
  },
  {
    "id": "fc8462e2.6bc6e",
    "type": "function",
    "z": "f0a27113.452c7",
    "name": "",
    "func": "\nmsg.payload = {ssid: msg.payload}\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 970,
    "y": 67,
    "wires": [
      [
        "4e417c79.0e9454"
      ]
    ]
  },
  {
    "id": "562a8ec7.a7e76",
    "type": "function",
    "z": "f0a27113.452c7",
    "name": "getPassphrase",
    "func": "var data = msg.payload\n\nvar command = `wpa_passphrase \"${data.ssid}\" \"${data.password}\" | sed '/#psk=\".*\"/d'`\n \nmsg.payload = command\n\nreturn msg",
    "outputs": 1,
    "noerr": 0,
    "x": 1320,
    "y": 67,
    "wires": [
      [
        "50f3b384.d92f4c"
      ]
    ]
  },
  {
    "id": "50f3b384.d92f4c",
    "type": "exec",
    "z": "f0a27113.452c7",
    "command": "",
    "addpay": true,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 1481,
    "y": 67,
    "wires": [
      [
        "201a9fb.244ff6"
      ],
      [],
      []
    ]
  },
  {
    "id": "201a9fb.244ff6",
    "type": "function",
    "z": "f0a27113.452c7",
    "name": "updateWpasupplicant",
    "func": "var template = `sudo tee /etc/wpa_supplicant/wpa_supplicant.conf <<EOF\nctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev\nupdate_config=1\ncountry=IT\n\n${msg.payload}\nEOF\\n\n`\n\nmsg.payload = template\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 1700,
    "y": 60,
    "wires": [
      [
        "d288a86d.e0ba48"
      ]
    ]
  },
  {
    "id": "d288a86d.e0ba48",
    "type": "exec",
    "z": "f0a27113.452c7",
    "command": "",
    "addpay": true,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "updateConf",
    "x": 1290,
    "y": 160,
    "wires": [
      [
        "ecc743df.05dd"
      ],
      [],
      []
    ]
  },
  {
    "id": "ecc743df.05dd",
    "type": "exec",
    "z": "f0a27113.452c7",
    "command": "sudo wpa_cli -i wlan0 reconfigure",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "reconfigure",
    "x": 1470,
    "y": 160,
    "wires": [
      [
        "2e12d3e8.51947c"
      ],
      [],
      []
    ]
  },
  {
    "id": "2e12d3e8.51947c",
    "type": "function",
    "z": "f0a27113.452c7",
    "name": "showMessage",
    "func": "\nmsg.payload = msg.payload.trim() === 'OK' ? \"Wifi configuration updated successfully\" : \"Error while updating wifi configuration\"\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 1680,
    "y": 160,
    "wires": [
      [
        "aa9d6712.91e718"
      ]
    ]
  },
  {
    "id": "aa9d6712.91e718",
    "type": "ui_toast",
    "z": "f0a27113.452c7",
    "position": "top right",
    "displayTime": "3",
    "highlight": "",
    "sendall": true,
    "outputs": 0,
    "ok": "OK",
    "cancel": "",
    "raw": false,
    "topic": "",
    "name": "",
    "x": 1950,
    "y": 160,
    "wires": []
  },
  {
    "id": "d4e866c7.6c3958",
    "type": "ui_button",
    "z": "f0a27113.452c7",
    "name": "",
    "group": "a1e7431b.229d5",
    "order": 1,
    "width": "0",
    "height": "0",
    "passthru": false,
    "label": "Back",
    "tooltip": "",
    "color": "",
    "bgcolor": "",
    "icon": "arrow_back",
    "payload": "Menu",
    "payloadType": "str",
    "topic": "",
    "x": 90,
    "y": 320,
    "wires": [
      [
        "49307dfc.36fce4"
      ]
    ]
  },
  {
    "id": "9aa43ac5.df3728",
    "type": "exec",
    "z": "f0a27113.452c7",
    "command": "iwgetid",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "getCurrentSSID",
    "x": 480,
    "y": 300,
    "wires": [
      [
        "6cff487b.f73b08"
      ],
      [],
      []
    ]
  },
  {
    "id": "4e1b74b8.84f51c",
    "type": "ui_text",
    "z": "f0a27113.452c7",
    "group": "a1e7431b.229d5",
    "order": 2,
    "width": 0,
    "height": 0,
    "name": "",
    "label": "SSID",
    "format": "{{msg.payload || '---'}}",
    "layout": "row-spread",
    "x": 830,
    "y": 280,
    "wires": []
  },
  {
    "id": "6cff487b.f73b08",
    "type": "function",
    "z": "f0a27113.452c7",
    "name": "parseInfo",
    "func": "var ssid = msg.payload.match(/ESSID:\"([^\"]+)\"/)[1]\n\n\nnode.send({topic: 'ssid', payload: ssid})\n",
    "outputs": 1,
    "noerr": 0,
    "x": 680,
    "y": 280,
    "wires": [
      [
        "4e1b74b8.84f51c"
      ]
    ]
  },
  {
    "id": "6a9ec6d5.0eca48",
    "type": "function",
    "z": "8ad7ff70.e6588",
    "name": "Set variabel",
    "func": "global.set(\"lodret\",2);\nglobal.set(\"vandret\",2);\nglobal.set(\"cam[1]\",\"rtsp://admin:987gnisten@192.168.40.83:554/Streaming/Channels/02\");\nglobal.set(\"cam[2]\",\"rtsp://admin:987gnisten@192.168.40.179:554/Streaming/Channels/02\");\nglobal.set(\"cam[3]\",\"rtsp://admin:987Gnisten@192.168.40.51:554/Streaming/Channels/02\");\nglobal.set(\"cam[4]\",\"rtsp://admin:987gnisten@192.168.40.90:554/Streaming/Channels/02\");\n\nreturn msg;\n\n\n//for(i=0; i<26; i++){\n//global.set(\"MaskinNavn[\"+i+\"]\",Maskine[i]);\n//global.set(\"Maskinenr[\"+i+\"]\", Maskinenr[i])\n//rtsp://10.1.5.40:7447/FehDwjQce0dLycRA",
    "outputs": 1,
    "noerr": 0,
    "initialize": "t=0;\nfor(s=0; s< global.get(\"lodret\"); s++){\nfor(i=0; i< global.get(\"vandret\"); i++){\nt++;\nglobal.set(\"running[\"+t+\"]\",\"false\");\nglobal.set(\"cam[\"+t+\"]\",\"\");\n}\n}\n",
    "finalize": "",
    "libs": [],
    "x": 570,
    "y": 180,
    "wires": [
      [
        "ec37d3d1.3fe95"
      ]
    ]
  },
  {
    "id": "ec37d3d1.3fe95",
    "type": "function",
    "z": "8ad7ff70.e6588",
    "name": "Kamera",
    "func": "var t = 0;\nfor(s=0; s< global.get(\"lodret\"); s++){\nfor(i=0; i< global.get(\"vandret\"); i++){\nt++;\nif (global.get(\"running[\"+t+\"]\")!=\"true\"){\nmsg.payload= \"screen -dmS cam\"+t+\" sh -c \"+\"\\\"omxplayer --avdict rtsp_transport:tcp --win '\"+1920/global.get(\"vandret\") * i+ \" \"+(1080/global.get(\"lodret\")) * (s)+\" \"+((1920/global.get(\"vandret\") * i)+(1920/global.get(\"vandret\")))+ \" \"+(1080/global.get(\"lodret\") *(s+1)) + \"' \"+ global.get(\"cam[\"+t+\"]\")+\" --live -n -1\"+\"\\\"\";\n//global.set(\"MaskinNavn[\"+i+\"]\",Maskine[i]);\nglobal.set(\"running[\"+t+\"]\",\"false\");\n node.send(msg);\n}\n}\n}",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 820,
    "y": 280,
    "wires": [
      [
        "255c056d.e630ba"
      ]
    ]
  },
  {
    "id": "255c056d.e630ba",
    "type": "exec",
    "z": "8ad7ff70.e6588",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 1030,
    "y": 180,
    "wires": [
      [
        "a8d70d9.34d7bf"
      ],
      [
        "a8d70d9.34d7bf"
      ],
      [
        "a8d70d9.34d7bf"
      ]
    ]
  },
  {
    "id": "1cd995ac.699baa",
    "type": "inject",
    "z": "8ad7ff70.e6588",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "screen -ls | grep cam | cut -d. -f1 | awk '{print $1}' | xargs kill",
    "payloadType": "str",
    "x": 810,
    "y": 60,
    "wires": [
      [
        "255c056d.e630ba"
      ]
    ]
  },
  {
    "id": "97800791.4ced48",
    "type": "inject",
    "z": "8ad7ff70.e6588",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "60",
    "crontab": "",
    "once": true,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "screen -ls | grep cam | cut -d. -f2  | awk '{print $1}'",
    "payloadType": "str",
    "x": 110,
    "y": 300,
    "wires": [
      [
        "b448be40.a4bf9",
        "88dcb7ef.4880f8"
      ]
    ]
  },
  {
    "id": "df6d6c66.b6c4e",
    "type": "split",
    "z": "8ad7ff70.e6588",
    "name": "",
    "splt": "\\n",
    "spltType": "str",
    "arraySplt": "1",
    "arraySpltType": "len",
    "stream": false,
    "addname": "",
    "x": 510,
    "y": 460,
    "wires": [
      [
        "e6bc37ff.26d4f8"
      ]
    ]
  },
  {
    "id": "fe502aa1.ee37c8",
    "type": "change",
    "z": "8ad7ff70.e6588",
    "name": "to number",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.payload)\t",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 820,
    "y": 460,
    "wires": [
      [
        "4cf72ea7.862cc"
      ]
    ]
  },
  {
    "id": "e6bc37ff.26d4f8",
    "type": "function",
    "z": "8ad7ff70.e6588",
    "name": "replace cam ",
    "func": "var str = msg.payload;\n\nvar res = str.replace(\"cam\", \"\");\nif (res !=\"\"){\nmsg.payload = res;\n node.send(msg);\n}\n//return msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 670,
    "y": 460,
    "wires": [
      [
        "fe502aa1.ee37c8"
      ]
    ]
  },
  {
    "id": "4cf72ea7.862cc",
    "type": "function",
    "z": "8ad7ff70.e6588",
    "name": "Sæt running cam til true",
    "func": "global.set(\"running[\"+msg.payload+\"]\",\"true\");\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1010,
    "y": 460,
    "wires": [
      []
    ]
  },
  {
    "id": "88dcb7ef.4880f8",
    "type": "exec",
    "z": "8ad7ff70.e6588",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "control running cam",
    "x": 310,
    "y": 440,
    "wires": [
      [
        "df6d6c66.b6c4e",
        "fff55273.d75d2"
      ],
      [],
      []
    ]
  },
  {
    "id": "fff55273.d75d2",
    "type": "function",
    "z": "8ad7ff70.e6588",
    "name": "Kamera kontrol til false",
    "func": "t=0;\nfor(s=0; s< global.get(\"lodret\"); s++){\nfor(i=0; i< global.get(\"vandret\"); i++){\nt++;\nglobal.set(\"running[\"+t+\"]\",\"false\");\n}\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 560,
    "y": 380,
    "wires": [
      []
    ]
  },
  {
    "id": "b448be40.a4bf9",
    "type": "delay",
    "z": "8ad7ff70.e6588",
    "name": "",
    "pauseType": "delay",
    "timeout": "500",
    "timeoutUnits": "milliseconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "outputs": 1,
    "x": 330,
    "y": 280,
    "wires": [
      [
        "eda6ac31.63c5b"
      ]
    ]
  },
  {
    "id": "b1fb8990.3e01d8",
    "type": "function",
    "z": "8ad7ff70.e6588",
    "d": true,
    "name": "Set variabel",
    "func": "global.set(\"lodret\",3);\nglobal.set(\"vandret\",4);\nglobal.set(\"cam[1]\",\"rtsp://95.154.26.79:7447/IUCnspDAOXW2bGOp\");\nglobal.set(\"cam[2]\",\"rtsp://95.154.26.79:7447/79uoS9pZdIHal5dx\");\nglobal.set(\"cam[3]\",\"rtsp://95.154.26.79:7447/FehDwjQce0dLycRA\");\nglobal.set(\"cam[4]\",\"rtsp://95.154.26.79:7447/XVGBx2ELKygUMkkP\");\nglobal.set(\"cam[5]\",\"rtsp://95.154.26.79:7447/uwa2Lp5NQToUV7Ps\");\nglobal.set(\"cam[6]\",\"rtsp://95.154.26.79:7447/5QBmCfV445FWY6T1\");\nglobal.set(\"cam[7]\",\"rtsp://95.154.26.79:7447/IUCnspDAOXW2bGOp\");\nglobal.set(\"cam[8]\",\"rtsp://re-elteknik.dk:5554/AWifeVxQTuHTcdIS\");\nglobal.set(\"cam[9]\",\"rtsp://re-elteknik.dk:5554/zyj228x7shMzJbPr\");\nglobal.set(\"cam[10]\",\"rtsp://admin:987Gnisten@46.32.51.86:6875/Streaming/Channels/02\");\nglobal.set(\"cam1[11]\",\"rtsp://admin:987Gnisten@46.32.51.86:6876/Streaming/Channels/02\");\nglobal.set(\"cam1[12]\",\"rtsp://admin:987Gnisten@46.32.51.86:6880/Streaming/Channels/02\");\nreturn msg;\n\n\n//for(i=0; i<26; i++){\n//global.set(\"MaskinNavn[\"+i+\"]\",Maskine[i]);\n//global.set(\"Maskinenr[\"+i+\"]\", Maskinenr[i])\n//rtsp://10.1.5.40:7447/FehDwjQce0dLycRA",
    "outputs": 1,
    "noerr": 0,
    "initialize": "t=0;\nfor(s=0; s< global.get(\"lodret\"); s++){\nfor(i=0; i< global.get(\"vandret\"); i++){\nt++;\nglobal.set(\"running[\"+t+\"]\",\"false\");\n}\n}\n",
    "finalize": "",
    "libs": [],
    "x": 550,
    "y": 60,
    "wires": [
      []
    ]
  },
  {
    "id": "eda6ac31.63c5b",
    "type": "function",
    "z": "8ad7ff70.e6588",
    "name": "Set variabel",
    "func": "global.set(\"lodret\",2);\nglobal.set(\"vandret\",2);\nglobal.set(\"cam[1]\",\"rtsp://re-elteknik.dk:5554/6tr4qdeZsXO9bt4h\");\nglobal.set(\"cam[2]\",\"rtsp://re-elteknik.dk:5554/uyflyPP3ItPQgNMQ\");\nglobal.set(\"cam[3]\",\"rtsp://re-elteknik.dk:5554/zyj228x7shMzJbPr\");\nglobal.set(\"cam[4]\",\"rtsp://re-elteknik.dk:5554/UEaPoEo2A5D5X4bm\");\nreturn msg;\n\n\n//for(i=0; i<26; i++){\n//global.set(\"MaskinNavn[\"+i+\"]\",Maskine[i]);\n//global.set(\"Maskinenr[\"+i+\"]\", Maskinenr[i])\n//rtsp://10.1.5.40:7447/FehDwjQce0dLycRA",
    "outputs": 1,
    "noerr": 0,
    "initialize": "t=0;\nfor(s=0; s< global.get(\"lodret\"); s++){\nfor(i=0; i< global.get(\"vandret\"); i++){\nt++;\nglobal.set(\"running[\"+t+\"]\",\"false\");\nglobal.set(\"cam[\"+t+\"]\",\"\");\n}\n}\n",
    "finalize": "",
    "libs": [],
    "x": 570,
    "y": 280,
    "wires": [
      [
        "ec37d3d1.3fe95"
      ]
    ]
  },
  {
    "id": "a8d70d9.34d7bf",
    "type": "debug",
    "z": "8ad7ff70.e6588",
    "name": "",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "true",
    "targetType": "full",
    "statusVal": "",
    "statusType": "auto",
    "x": 1190,
    "y": 180,
    "wires": []
  },
  {
    "id": "a18769fd.209978",
    "type": "inject",
    "z": "4390874a.e06198",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "1",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "Set ping period",
    "payload": "0",
    "payloadType": "num",
    "x": 170,
    "y": 180,
    "wires": [
      [
        "b3cf7c4.6a2528",
        "2e64ea55.ccf6d6",
        "4e28e5c4.3c5abc",
        "98a24ab5.4d5348"
      ]
    ]
  },
  {
    "id": "b3cf7c4.6a2528",
    "type": "conf ping",
    "z": "4390874a.e06198",
    "name": "",
    "host": "192.168.0.4",
    "timeout": "1",
    "requests": "1",
    "x": 650,
    "y": 180,
    "wires": [
      [
        "dd5bf82.072e408"
      ]
    ]
  },
  {
    "id": "c663acd9.ea6bc",
    "type": "debug",
    "z": "4390874a.e06198",
    "name": "",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "true",
    "targetType": "full",
    "statusVal": "",
    "statusType": "auto",
    "x": 1710,
    "y": 180,
    "wires": []
  },
  {
    "id": "dd5bf82.072e408",
    "type": "function",
    "z": "4390874a.e06198",
    "name": "main host to ping",
    "func": "msg2={};\nif (msg.payload <= 200){\n    msg2.payload=\"online :\"+msg.payload;\n    msg2.stop = 'green';\n}\nif (msg.payload == false){ \nmsg2.payload=\"false\";\nmsg2.stop = 'red';\n}\nnode.send(msg2);\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 990,
    "y": 180,
    "wires": [
      [
        "b0d384f7.1b1158"
      ]
    ]
  },
  {
    "id": "b0d384f7.1b1158",
    "type": "ui_button",
    "z": "4390874a.e06198",
    "name": "Vogn Bag",
    "group": "",
    "order": 22,
    "width": 5,
    "height": 2,
    "passthru": false,
    "label": "<font size=5>Vogn Bag :{{payload}}",
    "tooltip": "{{msg.online}}",
    "color": "",
    "bgcolor": "{{stop}}",
    "icon": "",
    "payload": "screen -dmS kameraBag sh -c \"omxplayer --avdict rtsp_transport:tcp --win '1286 0 1920 270' rtsp://admin:987Gnisten@192.168.0.13:554/Streaming/Channels/2 --live -n -1\"",
    "payloadType": "str",
    "topic": "topic",
    "topicType": "msg",
    "x": 1220,
    "y": 180,
    "wires": [
      [
        "3ce05304.8f8d5c"
      ]
    ]
  },
  {
    "id": "3ce05304.8f8d5c",
    "type": "exec",
    "z": "4390874a.e06198",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 1410,
    "y": 180,
    "wires": [
      [
        "c663acd9.ea6bc"
      ],
      [
        "c663acd9.ea6bc"
      ],
      [
        "c663acd9.ea6bc"
      ]
    ]
  },
  {
    "id": "658327d3.fbe938",
    "type": "inject",
    "z": "4390874a.e06198",
    "name": "",
    "props": [
      {
        "p": "kill",
        "v": "",
        "vt": "str"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payloadType": "str",
    "x": 1210,
    "y": 380,
    "wires": [
      [
        "3ce05304.8f8d5c"
      ]
    ]
  },
  {
    "id": "619a6272.90d9ac",
    "type": "ui_button",
    "z": "4390874a.e06198",
    "name": "",
    "group": "",
    "order": 23,
    "width": 2,
    "height": 2,
    "passthru": false,
    "label": "Stop",
    "tooltip": "{{msg.online}}",
    "color": "",
    "bgcolor": "{{stop}}",
    "icon": "",
    "payload": "screen -ls | grep kameraBag | cut -d. -f1 | awk '{print $1}' | xargs kill",
    "payloadType": "str",
    "topic": "topic",
    "topicType": "msg",
    "x": 1210,
    "y": 220,
    "wires": [
      [
        "3ce05304.8f8d5c"
      ]
    ]
  },
  {
    "id": "2e64ea55.ccf6d6",
    "type": "conf ping",
    "z": "4390874a.e06198",
    "name": "",
    "host": "192.168.0.10",
    "timeout": "1",
    "requests": "1",
    "x": 670,
    "y": 460,
    "wires": [
      [
        "cf321101.ca4b9"
      ]
    ]
  },
  {
    "id": "cf321101.ca4b9",
    "type": "function",
    "z": "4390874a.e06198",
    "name": "main host to ping",
    "func": "msg2={};\nif (msg.payload <= 300){\n    msg2.payload=\"online :\"+msg.payload;\n    msg2.stop = 'green';\n}\nif (msg.payload == false){ \nmsg2.payload=\"false\";\nmsg2.stop = 'red';\n}\nnode.send(msg2);\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1010,
    "y": 460,
    "wires": [
      [
        "33abe9a6.c718e6"
      ]
    ]
  },
  {
    "id": "33abe9a6.c718e6",
    "type": "ui_button",
    "z": "4390874a.e06198",
    "name": "Pumpe",
    "group": "",
    "order": 26,
    "width": 5,
    "height": 2,
    "passthru": false,
    "label": "<font size=5>Pumpe :{{payload}}",
    "tooltip": "{{msg.online}}",
    "color": "",
    "bgcolor": "{{stop}}",
    "icon": "",
    "payload": "screen -dmS kameraBag sh -c \"omxplayer --avdict rtsp_transport:tcp --win '1286 0 1920 270' rtsp://admin:987Gnisten@192.168.0.13:554/Streaming/Channels/2 --live -n -1\"",
    "payloadType": "str",
    "topic": "topic",
    "topicType": "msg",
    "x": 1240,
    "y": 460,
    "wires": [
      [
        "c1829e7a.74ae9"
      ]
    ]
  },
  {
    "id": "c1829e7a.74ae9",
    "type": "exec",
    "z": "4390874a.e06198",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 1430,
    "y": 460,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "764cd909.556308",
    "type": "inject",
    "z": "4390874a.e06198",
    "name": "",
    "props": [
      {
        "p": "kill",
        "v": "",
        "vt": "str"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payloadType": "str",
    "x": 1230,
    "y": 660,
    "wires": [
      [
        "c1829e7a.74ae9"
      ]
    ]
  },
  {
    "id": "d9a12add.04cb78",
    "type": "ui_button",
    "z": "4390874a.e06198",
    "name": "",
    "group": "",
    "order": 27,
    "width": 2,
    "height": 2,
    "passthru": false,
    "label": "Stop",
    "tooltip": "{{msg.online}}",
    "color": "",
    "bgcolor": "{{stop}}",
    "icon": "",
    "payload": "screen -ls | grep gylle | cut -d. -f1 | awk '{print $1}' | xargs kill",
    "payloadType": "str",
    "topic": "topic",
    "topicType": "msg",
    "x": 1250,
    "y": 520,
    "wires": [
      [
        "c1829e7a.74ae9"
      ]
    ]
  },
  {
    "id": "4e28e5c4.3c5abc",
    "type": "conf ping",
    "z": "4390874a.e06198",
    "name": "",
    "host": "192.168.0.13",
    "timeout": "1",
    "requests": "1",
    "x": 650,
    "y": 700,
    "wires": [
      [
        "6de4ddf5.6ccd94"
      ]
    ]
  },
  {
    "id": "6de4ddf5.6ccd94",
    "type": "function",
    "z": "4390874a.e06198",
    "name": "main host to ping",
    "func": "msg2={};\nif (msg.payload <= 200){\n    msg2.payload=\"online :\"+msg.payload;\n    msg2.stop = 'green';\n}\nif (msg.payload == false){ \nmsg2.payload=\"false\";\nmsg2.stop = 'red';\n}\nnode.send(msg2);\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 930,
    "y": 700,
    "wires": [
      [
        "6e2bac91.9466b4"
      ]
    ]
  },
  {
    "id": "2bd29811.119118",
    "type": "exec",
    "z": "4390874a.e06198",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 1410,
    "y": 700,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "6ac7605a.7745f",
    "type": "inject",
    "z": "4390874a.e06198",
    "name": "",
    "props": [
      {
        "p": "kill",
        "v": "",
        "vt": "str"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payloadType": "str",
    "x": 1210,
    "y": 900,
    "wires": [
      [
        "2bd29811.119118"
      ]
    ]
  },
  {
    "id": "a370b5c5.276978",
    "type": "ui_button",
    "z": "4390874a.e06198",
    "name": "",
    "group": "",
    "order": 18,
    "width": 2,
    "height": 2,
    "passthru": false,
    "label": "Stop",
    "tooltip": "{{msg.online}}",
    "color": "",
    "bgcolor": "{{stop}}",
    "icon": "",
    "payload": "screen -ls | grep gylle | cut -d. -f1 | awk '{print $1}' | xargs kill",
    "payloadType": "str",
    "topic": "topic",
    "topicType": "msg",
    "x": 1210,
    "y": 740,
    "wires": [
      [
        "2bd29811.119118"
      ]
    ]
  },
  {
    "id": "3fa197ec.ecab68",
    "type": "ui_button",
    "z": "4390874a.e06198",
    "name": "",
    "group": "",
    "order": 15,
    "width": 3,
    "height": 2,
    "passthru": false,
    "label": "<font size=5>HjÃ¦lp :-)",
    "tooltip": "{{msg.online}}",
    "color": "",
    "bgcolor": "{{stop}}",
    "icon": "",
    "payload": "sudo vncserver-x11 -service -connect 188.228.81.182::6666",
    "payloadType": "str",
    "topic": "topic",
    "topicType": "msg",
    "x": 1440,
    "y": 920,
    "wires": [
      [
        "fd7146c3.42e3c8"
      ]
    ]
  },
  {
    "id": "fd7146c3.42e3c8",
    "type": "exec",
    "z": "4390874a.e06198",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 1650,
    "y": 920,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "98a24ab5.4d5348",
    "type": "conf ping",
    "z": "4390874a.e06198",
    "name": "",
    "host": "8.8.8.8",
    "timeout": "1",
    "requests": "1",
    "x": 630,
    "y": 780,
    "wires": [
      [
        "b0e309aa.af8b18"
      ]
    ]
  },
  {
    "id": "b0e309aa.af8b18",
    "type": "function",
    "z": "4390874a.e06198",
    "name": "main host to ping",
    "func": "msg2={};\nif (msg.payload <= 100){\n    msg2.payload=\"online :\"+msg.payload;\n    msg2.stop = 'green';\n}\nif (msg.payload == false){ \nmsg2.payload=\"false\";\nmsg2.stop = 'red';\n}\nnode.send(msg2);\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 710,
    "y": 920,
    "wires": [
      [
        "9649ff7c.7b06d"
      ]
    ]
  },
  {
    "id": "9649ff7c.7b06d",
    "type": "ui_button",
    "z": "4390874a.e06198",
    "name": "",
    "group": "",
    "order": 16,
    "width": 3,
    "height": 2,
    "passthru": false,
    "label": "<font size=5>Internet",
    "tooltip": "{{msg.online}}",
    "color": "",
    "bgcolor": "{{stop}}",
    "icon": "",
    "payload": "",
    "payloadType": "str",
    "topic": "topic",
    "topicType": "msg",
    "x": 960,
    "y": 920,
    "wires": [
      []
    ]
  },
  {
    "id": "6e2bac91.9466b4",
    "type": "ui_button",
    "z": "4390874a.e06198",
    "name": "Vogn Top",
    "group": "",
    "order": 17,
    "width": 5,
    "height": 2,
    "passthru": false,
    "label": "<font size=5>Vogn Top :{{payload}}",
    "tooltip": "{{msg.online}}",
    "color": "",
    "bgcolor": "{{stop}}",
    "icon": "",
    "payload": "screen -dmS kameraBag sh -c \"omxplayer --avdict rtsp_transport:tcp --win '1286 0 1920 270' rtsp://admin:987Gnisten@192.168.0.13:554/Streaming/Channels/2 --live -n -1\"",
    "payloadType": "str",
    "topic": "topic",
    "topicType": "msg",
    "x": 1220,
    "y": 700,
    "wires": [
      [
        "2bd29811.119118"
      ]
    ]
  },
  {
    "id": "8fa64aef.f92408",
    "type": "ui_button",
    "z": "4390874a.e06198",
    "name": "",
    "group": "",
    "order": 21,
    "width": 6,
    "height": 4,
    "passthru": false,
    "label": "<font size=10>Genstart",
    "tooltip": "{{msg.online}}",
    "color": "",
    "bgcolor": "#fc03ec",
    "icon": "",
    "payload": "sudo bash /home/pi/gyllekamera.sh stop",
    "payloadType": "str",
    "topic": "topic",
    "topicType": "msg",
    "x": 1250,
    "y": 1000,
    "wires": [
      [
        "787b1534.748c3c"
      ]
    ]
  },
  {
    "id": "787b1534.748c3c",
    "type": "exec",
    "z": "4390874a.e06198",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "",
    "x": 1430,
    "y": 980,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "1",
    "type": "inject",
    "z": "bfa9dbf7.1685d8",
    "name": "Check hver minut",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "5",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 190,
    "y": 280,
    "wires": [
      [
        "8d2b7799.335c68",
        "b2fd6883.26add8"
      ]
    ]
  },
  {
    "id": "2",
    "type": "exec",
    "z": "bfa9dbf7.1685d8",
    "command": "pgrep omxplayer",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "Tjek omxplayer",
    "x": 580,
    "y": 240,
    "wires": [
      [
        "3"
      ],
      [],
      []
    ]
  },
  {
    "id": "3",
    "type": "function",
    "z": "bfa9dbf7.1685d8",
    "name": "Start omxplayer hvis ikke kørende",
    "func": "if (msg.payload === '') {\n    node.send({payload: 'omxplayer -o hdmi ' + global.get('kirke') + ' &'});\n}\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 860,
    "y": 240,
    "wires": [
      [
        "4"
      ]
    ]
  },
  {
    "id": "4",
    "type": "exec",
    "z": "bfa9dbf7.1685d8",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "Start omxplayer",
    "x": 1180,
    "y": 240,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "8cca6d38.24f1b",
    "type": "exec",
    "z": "bfa9dbf7.1685d8",
    "command": "ssh -R 6000:localhost:1880 ufitech@192.168.40.152 -p 22",
    "addpay": "",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "ssh",
    "x": 530,
    "y": 100,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "774387eb.91ea38",
    "type": "inject",
    "z": "bfa9dbf7.1685d8",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 340,
    "y": 100,
    "wires": [
      [
        "8cca6d38.24f1b"
      ]
    ]
  },
  {
    "id": "f739ac2d.7c156",
    "type": "exec",
    "z": "bfa9dbf7.1685d8",
    "command": "pkill omxplayer",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "Sluk omxplayer",
    "x": 580,
    "y": 320,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "c7fa8798.b43838",
    "type": "inject",
    "z": "bfa9dbf7.1685d8",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 380,
    "y": 380,
    "wires": [
      [
        "f739ac2d.7c156"
      ]
    ]
  },
  {
    "id": "8d2b7799.335c68",
    "type": "function",
    "z": "bfa9dbf7.1685d8",
    "name": "",
    "func": "if (global.get('kirke_true') === 1)\nreturn msg; \nelse  return null\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 380,
    "y": 260,
    "wires": [
      [
        "2"
      ]
    ]
  },
  {
    "id": "b2fd6883.26add8",
    "type": "function",
    "z": "bfa9dbf7.1685d8",
    "name": "",
    "func": "if (global.get('kirke_true') === 1)\nreturn null; \nelse  return msg",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 380,
    "y": 320,
    "wires": [
      [
        "f739ac2d.7c156"
      ]
    ]
  },
  {
    "id": "fbe47ef48b6e4637",
    "type": "mqtt-broker",
    "name": "mac-broker",
    "broker": "188.228.60.134",
    "port": "1883",
    "clientid": "",
    "usetls": false,
    "compatmode": true,
    "keepalive": "60",
    "cleansession": true,
    "birthTopic": "",
    "birthQos": "0",
    "birthPayload": "online",
    "closeTopic": "",
    "closeQos": "0",
    "closePayload": "offline",
    "willTopic": "",
    "willQos": "0",
    "willPayload": "offline"
  },
  {
    "id": "dee59bbd359748c4",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT health ping",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "60",
    "crontab": "",
    "once": true,
    "onceDelay": "5",
    "topic": "",
    "payload": "online",
    "payloadType": "str",
    "x": 180,
    "y": 620,
    "wires": [
      [
        "200329efdac24da9"
      ]
    ]
  },
  {
    "id": "200329efdac24da9",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT status payload",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nvar approved = !!flow.get('approved');\nvar base = approved ? 'devices/' + deviceId : 'devices/pending/' + deviceId;\nmsg.topic = base + '/status';\nmsg.payload = {\n    status: approved ? 'online' : 'pending',\n    approved: approved,\n    ts: Date.now(),\n    heartbeat: Date.now(),\n    ip: flow.get('localip') || '',\n    url: global.get('urlstore') || '',\n    mac: mac || ''\n};\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 430,
    "y": 620,
    "wires": [
      [
        "3b6eca84d3874e64"
      ]
    ]
  },
  {
    "id": "3b6eca84d3874e64",
    "type": "mqtt out",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT status out",
    "topic": "",
    "qos": "0",
    "retain": "true",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "fbe47ef48b6e4637",
    "x": 700,
    "y": 620,
    "wires": []
  },
  {
    "id": "b499fa98417e40ba",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT telemetry tick",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "60",
    "crontab": "",
    "once": true,
    "onceDelay": "10",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 180,
    "y": 680,
    "wires": [
      [
        "0b14e0f98fb74da6"
      ]
    ]
  },
  {
    "id": "0b14e0f98fb74da6",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "python3 /home/pi/mqtt-telemetry.py",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "MQTT telemetry exec",
    "x": 420,
    "y": 680,
    "wires": [
      [
        "2b79c31786964c0c"
      ],
      [],
      []
    ]
  },
  {
    "id": "2b79c31786964c0c",
    "type": "json",
    "z": "cb25fa82.4b5a98",
    "name": "Telemetry JSON",
    "property": "payload",
    "action": "",
    "pretty": false,
    "x": 630,
    "y": 680,
    "wires": [
      [
        "45d3119e7f434d41"
      ]
    ]
  },
  {
    "id": "45d3119e7f434d41",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT telemetry enrich",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nvar approved = !!flow.get('approved');\nvar base = approved ? 'devices/' + deviceId : 'devices/pending/' + deviceId;\nmsg.topic = base + '/telemetry';\nif (typeof msg.payload !== 'object') {\n    msg.payload = { raw: msg.payload };\n}\nmsg.payload.url = global.get('urlstore') || '';\nmsg.payload.ip = flow.get('localip') || msg.payload.ip || '';\nmsg.payload.ts = Date.now();\nmsg.payload.approved = approved;\nmsg.payload.mac = mac || '';\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 860,
    "y": 680,
    "wires": [
      [
        "e416b72965b34fc9"
      ]
    ]
  },
  {
    "id": "e416b72965b34fc9",
    "type": "mqtt out",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT telemetry out",
    "topic": "",
    "qos": "0",
    "retain": "false",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "fbe47ef48b6e4637",
    "x": 1090,
    "y": 680,
    "wires": []
  },
  {
    "id": "d191bb2a0ac9436a",
    "type": "mqtt in",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT cmd in",
    "topic": "devices/+/cmd/#",
    "qos": "0",
    "datatype": "auto",
    "broker": "fbe47ef48b6e4637",
    "nl": false,
    "rap": true,
    "rh": 0,
    "inputs": 0,
    "x": 160,
    "y": 760,
    "wires": [
      [
        "ef3d726da7334267"
      ]
    ]
  },
  {
    "id": "ef3d726da7334267",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT cmd validate",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nvar approved = !!flow.get('approved');\nif (!approved) { return null; }\nvar m = msg.topic.match(/^devices\\/([^/]+)\\/cmd\\/([^/]+)$/);\nif (!m) { return null; }\nif (m[1] !== deviceId && m[1] !== 'kiosk') { return null; }\nmsg.cmd = m[2];\nif (typeof msg.payload === 'string') {\n    try { msg.payload = JSON.parse(msg.payload); } catch(e) {}\n}\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 380,
    "y": 760,
    "wires": [
      [
        "65b4d0e0a214400e"
      ]
    ]
  },
  {
    "id": "65b4d0e0a214400e",
    "type": "switch",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT cmd switch",
    "property": "cmd",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "set-url",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "reboot",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "tv",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "support",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "ssh-tunnel",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "screenshot",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "wifi-scan",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "restart-nodered",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "restart-chromium",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "get-info",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "log-tail",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "ssh-web",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "get-location",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 13,
    "x": 590,
    "y": 760,
    "wires": [
      [
        "b89835b2a0964a45"
      ],
      [
        "b22912219eac4354"
      ],
      [
        "27812e1172014e09"
      ],
      [
        "e9a2f79213654ed6"
      ],
      [
        "3b871505bcfb4a1f"
      ],
      [
        "4c7d8965315a4f1b"
      ],
      [
        "ea6d6ed46d85425b"
      ],
      [
        "0d9b27825e924ba6"
      ],
      [
        "befe6234af0b4a7f"
      ],
      [
        "275f9eaee02a4fef"
      ],
      [
        "552a6b208f464285"
      ],
      [
        "919915f4fb414ec5"
      ],
      [
        "geolocation_exec_node"
      ]
    ]
  },
  {
    "id": "geolocation_exec_node",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "/home/pi/mqtt-geolocation.sh",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "30000",
    "oldrc": false,
    "name": "MQTT geolocation exec",
    "x": 850,
    "y": 1080,
    "wires": [
      [
        "geolocation_json_node"
      ],
      [],
      []
    ]
  },
  {
    "id": "geolocation_json_node",
    "type": "json",
    "z": "cb25fa82.4b5a98",
    "name": "Geolocation JSON",
    "property": "payload",
    "action": "",
    "pretty": false,
    "x": 1090,
    "y": 1080,
    "wires": [
      [
        "geolocation_topic_node"
      ]
    ]
  },
  {
    "id": "geolocation_topic_node",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT geolocation topic",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nmsg.topic = 'devices/' + deviceId + '/geolocation';\nmsg.payload.ts = Date.now();\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1310,
    "y": 1080,
    "wires": [
      [
        "geolocation_mqtt_out"
      ]
    ]
  },
  {
    "id": "geolocation_mqtt_out",
    "type": "mqtt out",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT geolocation out",
    "topic": "",
    "qos": "0",
    "retain": "false",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "fbe47ef48b6e4637",
    "x": 1530,
    "y": 1080,
    "wires": []
  },
  {
    "id": "b89835b2a0964a45",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT set url",
    "func": "var url = msg.payload;\nif (url && url.url) { url = url.url; }\nif (!url || typeof url !== 'string') { return null; }\n\nglobal.set('urlstore', url);\n\nvar fs = global.get('fs') || require('fs');\nvar model = '';\ntry { model = fs.readFileSync('/proc/device-tree/model', 'utf8'); } catch(e) { model = 'unknown'; }\n\nvar baseFlags = [\n    'pkill chromium; sleep 1;',\n    'DISPLAY=:0 chromium',\n    '--kiosk',\n    '--autoplay-policy=no-user-gesture-required',\n    '--disable-restore-session-state',\n    '--disable-session-crashed-bubble',\n    '--noerrordialogs',\n    '--disable-infobars',\n    '--disable-features=Translate',\n    '--disable-translate',\n    '--no-first-run',\n    '--start-fullscreen',\n    '--window-position=0,0',\n    '--window-size=1920,1080',\n    '--no-sandbox',\n    '--disable-dev-shm-usage',\n    '--user-stylesheet=file:///home/pi/hide-translate.css'\n];\n\nif (model.indexOf('Pi 4') !== -1 || model.indexOf('Pi 5') !== -1) {\n    baseFlags.push('--ignore-gpu-blocklist');\n    baseFlags.push('--enable-gpu-rasterization');\n    baseFlags.push('--enable-zero-copy');\n    baseFlags.push('--enable-features=VaapiVideoDecoder');\n    baseFlags.push('--use-gl=egl');\n} else if (model.indexOf('Pi 3') !== -1) {\n    baseFlags.push('--disable-gpu');\n    baseFlags.push('--disable-software-rasterizer');\n} else {\n    baseFlags.push('--disable-gpu');\n}\n\nmsg.payload = baseFlags.join(' ') + \" '\" + url + \"'\";\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 820,
    "y": 720,
    "wires": [
      [
        "930b2ef9163a430c"
      ]
    ]
  },
  {
    "id": "930b2ef9163a430c",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "MQTT start Chromium",
    "x": 1100,
    "y": 720,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "b22912219eac4354",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "sudo reboot",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "MQTT reboot",
    "x": 840,
    "y": 760,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "27812e1172014e09",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT tv control",
    "func": "var val = msg.payload;\nif (val && val.state) { val = val.state; }\nif (val === true) { val = 'on'; }\nif (val === false) { val = 'off'; }\nif (val === '1') { val = 'on'; }\nif (val === '0') { val = 'off'; }\n\nif (val === 'on') {\n    msg.payload = 'sudo sh -c \"echo \\\"on 0.0.0.0\\\" | cec-client -s -d 1\"';\n    return msg;\n}\nif (val === 'off') {\n    msg.payload = 'sudo sh -c \"echo \\\"standby 0.0.0.0\\\" | cec-client -s -d 1\"';\n    return msg;\n}\nreturn null;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 840,
    "y": 800,
    "wires": [
      [
        "7241946093aa47e5"
      ]
    ]
  },
  {
    "id": "7241946093aa47e5",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "MQTT TV exec",
    "x": 1100,
    "y": 800,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "e9a2f79213654ed6",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT support",
    "func": "var mode = (msg.payload && msg.payload.mode) ? msg.payload.mode : 'local';\nif (mode === 'reverse' && msg.payload && msg.payload.connect) {\n    msg.payload = 'sudo vncserver-x11 -service -connect ' + msg.payload.connect;\n    return msg;\n}\nmsg.payload = '/home/pi/start-vnc.sh';\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 820,
    "y": 840,
    "wires": [
      [
        "5392c0a1565342af"
      ]
    ]
  },
  {
    "id": "5392c0a1565342af",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "MQTT support exec",
    "x": 1100,
    "y": 840,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "3b871505bcfb4a1f",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT ssh tunnel",
    "func": "var p = msg.payload || {};\nvar action = (p.action || \"start\").toString();\nvar name = (p.name || \"default\").toString();\nvar host = (p.host || \"\").toString();\nvar user = (p.user || \"\").toString();\nvar remotePort = p.remote_port || p.remotePort || \"\";\nvar localPort = p.local_port || p.localPort || 22;\nvar key = (p.key || \"\").toString();\nvar port = p.port || p.tunnel_port || p.tunnelPort || \"\";\n\nfunction safeToken(value, pattern) {\n    var v = (value || \"\").toString().trim();\n    if (!v) { return \"\"; }\n    return pattern.test(v) ? v : \"\";\n}\n\nfunction safePort(value) {\n    var v = (value || \"\").toString().trim();\n    if (!v) { return \"\"; }\n    if (!/^[0-9]+$/.test(v)) { return \"\"; }\n    var num = Number(v);\n    if (!Number.isFinite(num) || num < 1 || num > 65535) { return \"\"; }\n    return String(num);\n}\n\naction = safeToken(action, /^(start|stop)$/);\nname = safeToken(name, /^[a-zA-Z0-9._-]+$/) || \"default\";\n\nif (action === \"stop\") {\n    msg.payload = \"/home/pi/ssh-tunnel.sh stop \" + name;\n    return msg;\n}\n\nhost = safeToken(host, /^[a-zA-Z0-9._-]+(:[0-9]+)?$/);\nuser = safeToken(user, /^[a-zA-Z0-9._-]+$/);\nremotePort = safePort(remotePort);\nlocalPort = safePort(localPort) || \"22\";\nkey = safeToken(key, /^\\/[a-zA-Z0-9._\\/-]+$/);\nport = safePort(port);\n\nif (!action || !host || !user || !remotePort) { return null; }\n\nvar cmd = \"/home/pi/ssh-tunnel.sh \" + action + \" \" + name + \" \" + host + \" \" + user + \" \" + remotePort + \" \" + localPort;\nif (key) { cmd += \" \" + key; }\nif (port) { cmd += \" \" + port; }\nmsg.payload = cmd;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 820,
    "y": 880,
    "wires": [
      [
        "dc559ae48d3c494b"
      ]
    ]
  },
  {
    "id": "dc559ae48d3c494b",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "MQTT ssh exec",
    "x": 1080,
    "y": 880,
    "wires": [
      [
        "e30aa1b7c5bc42f7"
      ],
      [],
      []
    ]
  },
  {
    "id": "e30aa1b7c5bc42f7",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT ssh response",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nmsg.topic = 'devices/' + deviceId + '/events';\nmsg.payload = {\n    ts: Date.now(),\n    type: 'ssh-tunnel',\n    result: (msg.payload || '').toString().trim()\n};\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1280,
    "y": 880,
    "wires": [
      [
        "7babe00acd6d4aac"
      ]
    ]
  },
  {
    "id": "7babe00acd6d4aac",
    "type": "mqtt out",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT events out",
    "topic": "",
    "qos": "0",
    "retain": "false",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "fbe47ef48b6e4637",
    "x": 1470,
    "y": 880,
    "wires": []
  },
  {
    "id": "4c7d8965315a4f1b",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT screenshot",
    "func": "var mode = (msg.payload && msg.payload.mode) ? msg.payload.mode : 'file';\nmsg.payload = '/home/pi/mqtt-screenshot.sh ' + mode;\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 820,
    "y": 920,
    "wires": [
      [
        "08772997e6774c5c"
      ]
    ]
  },
  {
    "id": "08772997e6774c5c",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "MQTT screenshot exec",
    "x": 1080,
    "y": 920,
    "wires": [
      [
        "ff934421d59549ad"
      ],
      [],
      []
    ]
  },
  {
    "id": "ff934421d59549ad",
    "type": "json",
    "z": "cb25fa82.4b5a98",
    "name": "Screenshot JSON",
    "property": "payload",
    "action": "",
    "pretty": false,
    "x": 1280,
    "y": 920,
    "wires": [
      [
        "dbeb38c92176458d"
      ]
    ]
  },
  {
    "id": "ec6128a49be54508",
    "type": "mqtt out",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT screenshot out",
    "topic": "",
    "qos": "0",
    "retain": "false",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "fbe47ef48b6e4637",
    "x": 1470,
    "y": 920,
    "wires": []
  },
  {
    "id": "ea6d6ed46d85425b",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "command": "nmcli -t -f SSID,SIGNAL,SECURITY dev wifi list --rescan yes",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "name": "MQTT wifi scan exec",
    "x": 840,
    "y": 960,
    "wires": [
      [
        "5d4813a12b154867"
      ],
      [],
      []
    ]
  },
  {
    "id": "5d4813a12b154867",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT wifi parse",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nvar lines = (msg.payload || '').toString().split(/\\r?\\n/).filter(function(l){return l.trim() !== '';});\nvar nets = lines.map(function(line){\n    var parts = line.split(':');\n    return { ssid: parts[0] || '', signal: parts[1] ? Number(parts[1]) : null, security: parts[2] || '' };\n});\nmsg.topic = 'devices/' + deviceId + '/wifi-scan';\nmsg.payload = { ts: Date.now(), networks: nets };\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1090,
    "y": 960,
    "wires": [
      [
        "cf2328993d524735"
      ]
    ]
  },
  {
    "id": "cf2328993d524735",
    "type": "mqtt out",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT wifi out",
    "topic": "",
    "qos": "0",
    "retain": "false",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "fbe47ef48b6e4637",
    "x": 1310,
    "y": 960,
    "wires": []
  },
  {
    "id": "dbeb38c92176458d",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT screenshot topic",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nmsg.topic = 'devices/' + deviceId + '/screenshot';\nmsg.payload.ts = Date.now();\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1470,
    "y": 920,
    "wires": [
      [
        "ec6128a49be54508"
      ]
    ]
  },
  {
    "id": "76f39c870b4e4789",
    "type": "inject",
    "z": "cb25fa82.4b5a98",
    "name": "Device identity init",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": true,
    "onceDelay": "1",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 170,
    "y": 560,
    "wires": [
      [
        "a328d1a9d503498b"
      ]
    ]
  },
  {
    "id": "a328d1a9d503498b",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "Load device identity",
    "func": "var fs = global.get('fs') || require('fs');\nvar idPath = '/home/pi/device-id';\nvar approvedPath = '/home/pi/device-approved';\nvar id = '';\ntry { id = fs.readFileSync(idPath, 'utf8').trim(); } catch(e) {}\nif (!id) { id = 'kiosk'; }\nvar approved = false;\ntry { approved = fs.existsSync(approvedPath); } catch(e) { approved = false; }\nflow.set('deviceId', id);\nflow.set('approved', approved);\n\nif (!approved) {\n    msg.topic = 'devices/pending/' + id + '/hello';\n    msg.payload = {\n        ts: Date.now(),\n        deviceId: id,\n        mac: flow.get('mac') || '',\n        ip: flow.get('localip') || ''\n    };\n    return msg;\n}\nreturn null;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 420,
    "y": 560,
    "wires": [
      [
        "dae8f390b00c48f1"
      ]
    ]
  },
  {
    "id": "dae8f390b00c48f1",
    "type": "mqtt out",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT pending hello out",
    "topic": "",
    "qos": "0",
    "retain": "false",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "fbe47ef48b6e4637",
    "x": 710,
    "y": 560,
    "wires": []
  },
  {
    "id": "a9454b2d88c2429d",
    "type": "mqtt in",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT approve in",
    "topic": "devices/pending/+/cmd/approve",
    "qos": "0",
    "datatype": "auto",
    "broker": "fbe47ef48b6e4637",
    "nl": false,
    "rap": true,
    "rh": 0,
    "inputs": 0,
    "x": 170,
    "y": 1000,
    "wires": [
      [
        "fed2d93d441d4be4"
      ]
    ]
  },
  {
    "id": "fed2d93d441d4be4",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT approve device",
    "func": "var fs = global.get('fs') || require('fs');\nvar mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nvar m = msg.topic.match(/^devices\\/pending\\/([^/]+)\\/cmd\\/approve$/);\nif (!m || m[1] !== deviceId) { return null; }\ntry { fs.writeFileSync('/home/pi/device-approved', 'approved\\n'); } catch(e) {}\nflow.set('approved', true);\nmsg.topic = 'devices/' + deviceId + '/events';\nmsg.payload = { ts: Date.now(), type: 'approved' };\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 450,
    "y": 1000,
    "wires": [
      [
        "a77ad6870e844cf4"
      ]
    ]
  },
  {
    "id": "a77ad6870e844cf4",
    "type": "mqtt out",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT approve out",
    "topic": "",
    "qos": "0",
    "retain": "false",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "fbe47ef48b6e4637",
    "x": 700,
    "y": 1000,
    "wires": []
  },
  {
    "id": "0d9b27825e924ba6",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT restart nodered exec",
    "command": "sudo systemctl restart nodered",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "x": 880,
    "y": 1040,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "befe6234af0b4a7f",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT restart chromium exec",
    "command": "pkill chromium",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "x": 880,
    "y": 1080,
    "wires": [
      [],
      [],
      []
    ]
  },
  {
    "id": "275f9eaee02a4fef",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT get info exec",
    "command": "/home/pi/mqtt-info.sh",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "x": 860,
    "y": 1120,
    "wires": [
      [
        "510583efdca24031"
      ],
      [],
      []
    ]
  },
  {
    "id": "510583efdca24031",
    "type": "json",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT get info json",
    "property": "payload",
    "action": "",
    "pretty": false,
    "x": 1090,
    "y": 1120,
    "wires": [
      [
        "f63282f0ff8b42e3"
      ]
    ]
  },
  {
    "id": "f63282f0ff8b42e3",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT get info event",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nmsg.topic = 'devices/' + deviceId + '/events';\nmsg.payload.ts = Date.now();\nmsg.payload.type = 'info';\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1320,
    "y": 1120,
    "wires": [
      [
        "7babe00acd6d4aac"
      ]
    ]
  },
  {
    "id": "552a6b208f464285",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT log tail exec",
    "command": "/home/pi/mqtt-log-tail.sh",
    "addpay": false,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "x": 850,
    "y": 1160,
    "wires": [
      [
        "96058ccc72374bd5"
      ],
      [],
      []
    ]
  },
  {
    "id": "96058ccc72374bd5",
    "type": "json",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT log tail json",
    "property": "payload",
    "action": "",
    "pretty": false,
    "x": 1080,
    "y": 1160,
    "wires": [
      [
        "33b3d056145443b6"
      ]
    ]
  },
  {
    "id": "33b3d056145443b6",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT log tail event",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nmsg.topic = 'devices/' + deviceId + '/events';\nmsg.payload.ts = Date.now();\nmsg.payload.type = 'log-tail';\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1320,
    "y": 1160,
    "wires": [
      [
        "7babe00acd6d4aac"
      ]
    ]
  },
  {
    "id": "919915f4fb414ec5",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT web ssh",
    "func": "var action = (msg.payload && msg.payload.action) ? msg.payload.action : 'start';\nmsg.payload = '/home/pi/web-ssh.sh ' + action;\nmsg.webAction = action;\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 820,
    "y": 1200,
    "wires": [
      [
        "cb09a388aa604ea4"
      ]
    ]
  },
  {
    "id": "cb09a388aa604ea4",
    "type": "exec",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT web ssh exec",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "oldrc": false,
    "x": 1060,
    "y": 1200,
    "wires": [
      [
        "5933222a72a94bf1"
      ],
      [],
      []
    ]
  },
  {
    "id": "5933222a72a94bf1",
    "type": "function",
    "z": "cb25fa82.4b5a98",
    "name": "MQTT web ssh event",
    "func": "var mac = flow.get('mac');\nvar deviceId = flow.get('deviceId') || (mac ? ('ufi_tech-' + mac) : 'kiosk');\nmsg.topic = 'devices/' + deviceId + '/events';\nmsg.payload = {\n  ts: Date.now(),\n  type: 'web-ssh',\n  result: (msg.payload || '').toString().trim()\n};\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1300,
    "y": 1200,
    "wires": [
      [
        "7babe00acd6d4aac"
      ]
    ]
  }
]
